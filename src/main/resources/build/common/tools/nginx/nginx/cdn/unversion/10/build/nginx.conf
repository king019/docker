user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

 

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    gzip  on;


    #开始设置代理缓存，尝试一下cdn
    proxy_buffering               on;
    proxy_buffer_size             128m;
    proxy_buffers                 1024 4m;
    proxy_busy_buffers_size       128m;
    proxy_temp_file_write_size    128m;
    proxy_cache_lock              on;
    proxy_cache_lock_timeout      5000ms;
    proxy_temp_path               /var/log/nginx/proxy_temp;

  #keys_zone=cache:
    proxy_cache_path              /var/log/nginx/proxy_cache levels=1:2 keys_zone=tmpcache:5120m inactive=240h max_size=8g;


    proxy_connect_timeout        3s;
    proxy_read_timeout           5s;
    proxy_send_timeout           5s;

    

    server {
    	listen       80;
    	server_name  repo.huaweicloud.com;#你的域名
    	charset utf8;

    	proxy_set_header        Host            $host;
    	proxy_set_header        X-Real-IP       $remote_addr;
    	proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    	proxy_set_header        X-Up-Calling-Line-Id $http_x_up_calling_line_id;
    	proxy_ignore_headers    X-Accel-Expires Expires Cache-Control Set-Cookie;

    	access_log /var/log/nginx/access.log;

    	location / {
    			proxy_pass http://mirrors.huaweicloud.com:80;
    			#proxy_cache 的值是 proxy_cache_path 中的 keys_zone 的值
    			proxy_cache tmpcache;
    			#缓存 key 的值
    			proxy_cache_key $host$uri$is_args$args;
    			proxy_cache_valid 200 301 5m;
    			proxy_cache_use_stale updating error timeout invalid_header http_500 http_502 http_503 http_504;

    			expires 1m;
    			# 将缓存的状态添加到 Header 中
    			add_header X-Cache '$upstream_cache_status';
    	}
    }
}